{% extends 'myapp/base.html' %}

{% block title %}Mensajes{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Mensajes</h1>

    <!-- Formulario para enviar un nuevo mensaje -->
    <div class="card mb-4">
        <div class="card-header">
            Enviar Nuevo Mensaje
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'enviar_mensaje' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="receptor">Para:</label>
                    <select name="receptor" id="receptor" class="form-control">
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="contenido">Mensaje:</label>
                    <textarea name="contenido" id="contenido" class="form-control" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Enviar</button>
            </form>
        </div>
    </div>

    <!-- Mensajes Recibidos -->
    <h2>Mensajes Recibidos</h2>
    <ul class="list-group mb-4">
        {% for mensaje in mensajes_recibidos %}
        <li class="list-group-item">
            <strong>De:</strong> {{ mensaje.emisor.username }}<br>
            <strong>Mensaje:</strong> {{ mensaje.contenido }}<br>
            <strong>Enviado:</strong> {{ mensaje.fecha_envio }}<br>
            <a href="#" class="btn btn-sm btn-primary mt-2 responder-btn" data-emisor-id="{{ mensaje.emisor.id }}">Responder</a>
            <button type="button" class="btn btn-sm btn-danger mt-2" data-toggle="modal" data-target="#confirmDeleteModal" data-mensaje-id="{{ mensaje.id }}">Eliminar</button>
        </li>
        {% empty %}
        <li class="list-group-item">No tienes mensajes recibidos.</li>
        {% endfor %}
    </ul>

    <!-- Mensajes Enviados -->
    <h2>Mensajes Enviados</h2>
    <ul class="list-group mb-4">
        {% for mensaje in mensajes_enviados %}
        <li class="list-group-item">
            <strong>Para:</strong> {{ mensaje.receptor.username }}<br>
            <strong>Mensaje:</strong> {{ mensaje.contenido }}<br>
            <strong>Enviado:</strong> {{ mensaje.fecha_envio }}<br>
            <button type="button" class="btn btn-sm btn-danger mt-2" data-toggle="modal" data-target="#confirmDeleteModal" data-mensaje-id="{{ mensaje.id }}">Eliminar</button>
        </li>
        {% empty %}
        <li class="list-group-item">No has enviado mensajes.</li>
        {% endfor %}
    </ul>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar este mensaje?
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Incluir jQuery primero -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Incluir Bootstrap JS después de jQuery -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    $('#confirmDeleteModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) 
        var mensajeId = button.data('mensaje-id') 
        var action = "{% url 'eliminar_mensaje' 0 %}".slice(0, -2) + mensajeId + "/";
        var modal = $(this)
        modal.find('#deleteForm').attr('action', action);
    })

    // Preseleccionar el usuario para responder
    $('.responder-btn').on('click', function (event) {
        event.preventDefault();
        var emisorId = $(this).data('emisor-id');
        $('#receptor').val(emisorId);
        $('html, body').animate({
            scrollTop: $("#receptor").offset().top
        }, 1000);
    });
</script>
{% endblock %}
